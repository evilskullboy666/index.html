<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WeatherScope - Visitor Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background-color: #101418; color: #f0f0f0; font-family: sans-serif; margin: 0; }
    header { background: #1f2933; padding: 25px; text-align: center; }
    h1 { margin: 0; font-size: 30px; }
    #weatherContainer { text-align: center; padding: 40px 20px; }
    input, button { padding: 10px; border-radius: 5px; border: none; margin: 5px; }
    #weatherResult { display: none; margin-top: 20px; background: #1e293b; padding: 20px; border-radius: 10px; }
    #map { width: 100%; height: 400px; margin-top: 30px; border-top: 1px solid #333; }
    footer { text-align: center; padding: 20px; font-size: 12px; color: #999; border-top: 1px solid #2e3a4a; }
    #loginModal, #adminPanel { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
    #adminPanel { top: 20px; left: auto; right: 20px; background: #1e293b; width: 400px; height: auto; padding: 20px; border-radius: 10px; display: none; flex-direction: column; color: white; z-index: 1000; position: fixed; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>

<header>
  <h1>☀️ WeatherScope</h1>
  <p>Get weather & log visitor info accurately</p>
</header>

<div id="weatherContainer">
  <input type="text" id="locationInput" placeholder="Enter city">
  <button onclick="fetchByCity()">Get Weather</button>
  <button onclick="detectLocation()">📍 Use My Location</button>
  <div id="weatherResult"></div>
  <div id="map"></div>
</div>

<div id="loginModal">
  <div style="background: #1f2933; padding: 30px; border-radius: 10px; text-align: center; width: 300px;">
    <h3>Admin Login</h3>
    <input id="adminUser" placeholder="Username"><br>
    <input type="password" id="adminPass" placeholder="Password"><br>
    <button onclick="loginAdmin()">Login</button>
    <p id="loginError" style="color:red; display:none">Invalid</p>
  </div>
</div>

<div id="adminPanel">
  <h3>🔐 Admin Dashboard</h3>
  <p><strong>Total Records:</strong> <span id="locationCount">0</span></p>
  <button onclick="exportData()">📄 Export</button>
  <button onclick="viewRawData()">👁️ View Data</button>
  <button onclick="clearAllData()">🗑️ Clear</button>
  <button onclick="hideAdmin()">❌ Hide</button>
  <div id="rawDataDisplay" style="margin-top:10px"></div>
</div>

<footer>WeatherScope &copy; 2025</footer>

<script>
function detectLocation() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;
      const timestamp = new Date().toISOString();
      logVisitor(lat, lon, accuracy, timestamp);
      fetchWeatherByCoords(lat, lon);
    },
    err => alert("Location denied"),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function fetchByCity() {
  const city = document.getElementById("locationInput").value;
  if (!city) return;
  fetchWeather(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=YOUR_API_KEY`);
}

function fetchWeatherByCoords(lat, lon) {
  fetchWeather(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=YOUR_API_KEY`);
}

function fetchWeather(url) {
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.cod !== 200) return alert("Not found");
      document.getElementById("weatherResult").style.display = "block";
      document.getElementById("weatherResult").innerHTML = `
        <h2>${data.name}, ${data.sys.country}</h2>
        <p><strong>${data.weather[0].main}</strong> - ${data.main.temp} °C</p>`;
      initMap(data.coord.lat, data.coord.lon);
    });
}

function initMap(lat, lon) {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 10,
    center: { lat, lng: lon },
  });
  new google.maps.Marker({ position: { lat, lng: lon }, map });
}

function logVisitor(lat, lon, accuracy, timestamp) {
  const geocoder = new google.maps.Geocoder();
  geocoder.geocode({ location: { lat, lng: lon } }, (results, status) => {
    const address = status === "OK" && results[0] ? results[0].formatted_address : "Unknown";
    const entry = {
      timestamp,
      lat,
      lon,
      accuracy,
      address,
      userAgent: navigator.userAgent,
      screen: `${screen.width}x${screen.height}`,
      platform: navigator.platform,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    const logs = JSON.parse(localStorage.getItem("visitorLogs") || "[]");
    logs.push(entry);
    localStorage.setItem("visitorLogs", JSON.stringify(logs));
    updateLocationCount();
  });
}

function updateLocationCount() {
  const logs = JSON.parse(localStorage.getItem("visitorLogs") || "[]");
  document.getElementById("locationCount").innerText = logs.length;
}

function loginAdmin() {
  const u = document.getElementById("adminUser").value;
  const p = document.getElementById("adminPass").value;
  if (u === "admin" && p === "admin123") {
    document.getElementById("loginModal").style.display = "none";
    document.getElementById("adminPanel").style.display = "flex";
    updateLocationCount();
    viewRawData();
  } else {
    document.getElementById("loginError").style.display = "block";
  }
}

function exportData() {
  const data = localStorage.getItem("visitorLogs") || "[]";
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "visitorLogs.json";
  a.click();
  URL.revokeObjectURL(url);
}

function viewRawData() {
  const logs = JSON.parse(localStorage.getItem("visitorLogs") || "[]");
  const display = logs.map((l, i) => `#${i+1} | ${l.timestamp}\n${l.address}\nLat: ${l.lat}, Lon: ${l.lon}\nAcc: ±${l.accuracy}m\nUser: ${l.userAgent}\n`).join("\n\n");
  document.getElementById("rawDataDisplay").innerHTML = `<pre>${display || "No logs yet."}</pre>`;
}

function clearAllData() {
  localStorage.removeItem("visitorLogs");
  updateLocationCount();
  document.getElementById("rawDataDisplay").innerHTML = "Logs cleared.";
}

function hideAdmin() {
  document.getElementById("adminPanel").style.display = "none";
}

// Shortcut to open admin
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a') {
    document.getElementById("loginModal").style.display = "flex";
  }
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_Wf43YItG5wLQ9uPXtjhGc7bfAa9B09w&callback=initMap"></script>

</body>
</html>
