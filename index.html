<script>
  let map;
  let markers = [];

  // Mobile-friendly location permission check
  window.onload = function() {
    // Ask only if permissions not previously denied (for iOS Safari support)
    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
        if (result.state !== 'denied') {
          getCurrentLocation();
        }
      }).catch(function() {
        getCurrentLocation(); // fallback
      });
    } else {
      getCurrentLocation();
    }

    checkAdminAccess();
    simulateWeatherData();
  };

  // Secret admin access
  function checkAdminAccess() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('admin') === 'secret') {
      showLoginModal();
      return;
    }
  }

  document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && event.shiftKey && event.key === 'A') {
      event.preventDefault();
      showLoginModal();
    }
  });

  function showLoginModal() {
    document.getElementById('loginModal').style.display = 'block';
    document.getElementById('adminUsername').focus();
  }

  function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('loginError').style.display = 'none';
  }

  function attemptLogin() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    if (username === 'admin' && password === 'epic') {
      closeLoginModal();
      showAdminPanel();
    } else {
      document.getElementById('loginError').style.display = 'block';
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminPassword').focus();
    }
  }

  document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter' && document.getElementById('loginModal').style.display === 'block') {
      attemptLogin();
    }
  });

  function initMap() {
    const defaultLocation = { lat: 0, lng: 0 };
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 2,
      center: defaultLocation,
      styles: [
        {
          "featureType": "all",
          "elementType": "geometry.fill",
          "stylers": [{"color": "#74b9ff"}]
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [{"color": "#0984e3"}]
        }
      ]
    });
    getCurrentLocation();
  }

  function getCurrentLocation() {
    document.getElementById('locationName').innerHTML = 'ðŸ“ Detecting location...';
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const myLatLng = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(myLatLng);
          map.setZoom(15);
          addMarker(myLatLng);
          saveLocation(myLatLng);
          updateLocationDisplay(myLatLng);
        },
        (error) => {
          document.getElementById('locationName').innerHTML = 'ðŸ“ Location unavailable';
          console.error("Geolocation error:", error);
        }
      );
    } else {
      document.getElementById('locationName').innerHTML = 'ðŸ“ Geolocation not supported';
    }
  }

  function addMarker(location) {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    const marker = new google.maps.Marker({
      position: location,
      map: map,
      title: "Your current location",
      icon: {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="8" fill="#74b9ff" stroke="white" stroke-width="3"/>
            <circle cx="16" cy="16" r="3" fill="white"/>
          </svg>
        `),
        scaledSize: new google.maps.Size(32, 32),
        anchor: new google.maps.Point(16, 16)
      }
    });
    markers.push(marker);
  }

  function updateLocationDisplay(location) {
    document.getElementById('locationName').innerHTML =
      `ðŸ“ Lat: ${location.lat.toFixed(4)}, Lng: ${location.lng.toFixed(4)}`;
  }

  function saveLocation(location) {
    let savedLocations = JSON.parse(localStorage.getItem('locationHistory')) || [];
    const locationData = {
      lat: location.lat,
      lng: location.lng,
      timestamp: new Date().toISOString(),
      readableTime: new Date().toLocaleString()
    };
    savedLocations.push(locationData);
    if (savedLocations.length > 100) {
      savedLocations = savedLocations.slice(-100);
    }
    localStorage.setItem('locationHistory', JSON.stringify(savedLocations));
  }

  function simulateWeatherData() {
    setTimeout(() => {
      document.querySelector('.temp').textContent = '72Â°F';
      document.querySelector('.condition').textContent = 'Partly Cloudy';
      document.querySelectorAll('.detail-item .value')[0].textContent = '65%';
      document.querySelectorAll('.detail-item .value')[1].textContent = '8 mph';
      document.querySelectorAll('.detail-item .value')[2].textContent = '1013 mb';
      document.querySelectorAll('.detail-item .value')[3].textContent = '10 mi';
    }, 2000);
  }

  function showAdminPanel() {
    document.getElementById('adminPanel').style.display = 'block';
    updateLocationCount();
    document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
  }

  function hideAdmin() {
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('rawDataDisplay').style.display = 'none';
  }

  function updateLocationCount() {
    const savedLocations = JSON.parse(localStorage.getItem('locationHistory')) || [];
    document.getElementById('locationCount').textContent = savedLocations.length;
  }

  function viewRawData() {
    const rawDisplay = document.getElementById('rawDataDisplay');
    const savedLocations = JSON.parse(localStorage.getItem('locationHistory')) || [];
    if (savedLocations.length === 0) {
      rawDisplay.innerHTML = 'No location data stored.';
    } else {
      rawDisplay.innerHTML = '<pre>' + JSON.stringify(savedLocations, null, 2) + '</pre>';
    }
    rawDisplay.style.display = rawDisplay.style.display === 'none' ? 'block' : 'none';
  }

  function clearAllData() {
    if (confirm('âš ï¸ WARNING: This will permanently delete ALL stored location data. Are you sure?')) {
      localStorage.removeItem('locationHistory');
      alert('All location data has been cleared.');
      updateLocationCount();
      document.getElementById('rawDataDisplay').style.display = 'none';
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }
  }
</script>
